<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E.RECALLER - Feedback System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <meta name="referrer" content="no-referrer">
  <style>
    :root {
      --primary: #4a6bff;
      --secondary: #8a2be2;
      --accent: #ff6b6b;
      --text: #333;
      --light-bg: #f9f9f9;
      --card-bg: rgba(255, 255, 255, 0.95);
      --overlay: rgba(0, 0, 0, 0.5);
    }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      color: var(--text);
      line-height: 1.6;
      background: url('https://images.unsplash.com/photo-1434030216411-0b793f4b4173?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      position: relative;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--overlay);
      z-index: -1;
    }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 5%;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }

    .nav-links {
      display: flex;
      gap: 1.5rem;
    }

    .nav-links a {
      text-decoration: none;
      color: var(--text);
      font-weight: 500;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .nav-links a:hover {
      color: var(--primary);
      transform: translateY(-2px);
    }

    .feedback-section {
      max-width: 1000px;
      margin: 3rem auto;
      padding: 0 2rem;
      animation: fadeIn 0.8s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-title {
      text-align: center;
      font-size: 2.2rem;
      margin-bottom: 2rem;
      color: white;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .feedback-container {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      padding: 2rem;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .feedback-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .feedback-title {
      font-size: 1.5rem;
      margin: 0;
      color: var(--primary);
    }

    .feedback-button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .feedback-button:hover {
      background: #3a5bed;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(74, 107, 255, 0.3);
    }

    .feedback-items {
      display: grid;
      gap: 1.5rem;
    }

    .feedback-item {
      background: var(--light-bg);
      padding: 1.5rem;
      border-radius: 8px;
      border-left: 4px solid var(--primary);
      transition: all 0.3s;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .feedback-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .feedback-meta {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .feedback-author {
      font-weight: 600;
      color: var(--primary);
    }

    .feedback-date {
      color: #666;
    }

    .feedback-rating {
      color: #ffb400;
      font-size: 1.1rem;
      margin: 0.5rem 0;
    }

    .feedback-content {
      margin-top: 0.5rem;
      color: #444;
    }

    .no-feedback {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      position: relative;
    }

    .close-modal {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
      background: none;
      border: none;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: 'Poppins', sans-serif;
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
    }

    .submit-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      width: 100%;
      transition: all 0.3s;
      position: relative;
    }

    .submit-btn:hover {
      background: #3a5bed;
    }

    .rating-container {
      display: flex;
      justify-content: center;
      margin: 1rem 0;
    }

    .rating-container input {
      display: none;
    }

    .rating-container label {
      font-size: 2rem;
      color: #ddd;
      cursor: pointer;
      transition: all 0.2s;
    }

    .rating-container input:checked ~ label,
    .rating-container label:hover,
    .rating-container label:hover ~ label {
      color: #ffb400;
    }

    .rating-container input:checked + label {
      color: #ffb400;
    }

    .success-message {
      display: none;
      text-align: center;
      padding: 2rem;
      color: var(--primary);
      font-weight: 600;
    }

    .error-message {
      color: var(--accent);
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ffcccc;
      border-radius: 4px;
      background: #fff5f5;
    }

    .retry-button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 1rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .network-error {
      background: #fff5f5;
      border-left: 4px solid var(--accent);
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 4px;
    }

    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        padding: 1rem;
      }

      .nav-links {
        margin-top: 1rem;
        flex-wrap: wrap;
        justify-content: center;
      }

      .feedback-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }

      .modal-content {
        width: 95%;
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <header class="navbar">
    <div class="logo">E.RECALLER</div>
    <nav class="nav-links">
      <a href="index.html"><i class="fas fa-home"></i> Home</a>
      <a href="about.html"><i class="fas fa-info-circle"></i> About</a>
      <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
      <a href="help.html"><i class="fas fa-question-circle"></i> Help</a>
    </nav>
  </header>

  <!-- Feedback Section -->
  <section class="feedback-section">
    <h2 class="section-title">User Feedback</h2>
    <div class="feedback-container">
      <div class="feedback-header">
        <h3 class="feedback-title">What Learners Say</h3>
        <button class="feedback-button" id="openFeedbackForm">
          <i class="fas fa-plus"></i> Add Feedback
        </button>
      </div>
      <div class="feedback-items" id="feedbackItems">
        <div class="no-feedback">
          <p><i class="fas fa-spinner fa-spin"></i> Loading feedback...</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Feedback Modal -->
  <div class="modal" id="feedbackModal">
    <div class="modal-content">
      <button class="close-modal" id="closeModal">&times;</button>
      <h2 style="margin-top: 0; color: var(--primary);">Share Your Feedback</h2>
      
      <form id="feedbackForm">
        <div id="formError" class="error-message" style="display: none;"></div>
        
        <div class="form-group">
          <label for="name">Your Name (optional)</label>
          <input type="text" id="name" name="name" placeholder="John Doe">
        </div>
        
        <div class="form-group">
          <label>Rating</label>
          <div class="rating-container">
            <input type="radio" id="star5" name="rating" value="5">
            <label for="star5">★</label>
            <input type="radio" id="star4" name="rating" value="4">
            <label for="star4">★</label>
            <input type="radio" id="star3" name="rating" value="3">
            <label for="star3">★</label>
            <input type="radio" id="star2" name="rating" value="2">
            <label for="star2">★</label>
            <input type="radio" id="star1" name="rating" value="1" checked>
            <label for="star1">★</label>
          </div>
        </div>
        
        <div class="form-group">
          <label for="feedback">Your Feedback</label>
          <textarea id="feedback" name="feedback" placeholder="Share your experience..." required></textarea>
        </div>
        
        <button type="submit" class="submit-btn">
          <span id="submitText">Submit Feedback</span>
          <span id="submitSpinner" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i> Processing...
          </span>
        </button>
      </form>
      
      <div class="success-message" id="successMessage">
        <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
        <p>Thank you for your feedback!</p>
        <p>Your input helps us improve.</p>
      </div>
    </div>
  </div>

  <script>
    // Configuration - REPLACE WITH YOUR APPS SCRIPT DEPLOYMENT URL
    const CONFIG = {
      SCRIPT_URL: "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec",
      MAX_RETRIES: 3,
      TIMEOUT: 8000
    };

    // DOM Elements
    const feedbackModal = document.getElementById('feedbackModal');
    const openFeedbackForm = document.getElementById('openFeedbackForm');
    const closeModal = document.getElementById('closeModal');
    const feedbackForm = document.getElementById('feedbackForm');
    const successMessage = document.getElementById('successMessage');
    const formError = document.getElementById('formError');
    const submitText = document.getElementById('submitText');
    const submitSpinner = document.getElementById('submitSpinner');
    const feedbackItems = document.getElementById('feedbackItems');

    // Modal Controls
    openFeedbackForm.addEventListener('click', () => feedbackModal.style.display = 'flex');
    closeModal.addEventListener('click', closeFeedbackModal);
    feedbackModal.addEventListener('click', (e) => e.target === feedbackModal && closeFeedbackModal());

    function closeFeedbackModal() {
      feedbackModal.style.display = 'none';
      resetForm();
    }

    function resetForm() {
      feedbackForm.reset();
      feedbackForm.style.display = 'block';
      successMessage.style.display = 'none';
      formError.style.display = 'none';
    }

    // Enhanced fetch with timeout and automatic JSONP fallback
    async function safeFetch(url, options = {}) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);
      
      try {
        // First try regular fetch
        const response = await fetch(url, {
          ...options,
          signal: controller.signal,
          referrerPolicy: 'no-referrer'
        });
        
        // If CORS fails, try JSONP
        if (!response.ok || response.status === 0) {
          return await jsonpFetch(url);
        }
        
        clearTimeout(timeoutId);
        return response;
      } catch (error) {
        clearTimeout(timeoutId);
        throw error;
      }
    }

    // JSONP fallback method
    function jsonpFetch(url) {
      return new Promise((resolve, reject) => {
        const callbackName = `jsonp_${Date.now()}`;
        const script = document.createElement('script');
        
        window[callbackName] = (data) => {
          delete window[callbackName];
          document.body.removeChild(script);
          resolve({
            ok: true,
            json: () => Promise.resolve(data)
          });
        };
        
        script.src = `${url}?callback=${callbackName}`;
        script.onerror = () => {
          reject(new Error('JSONP request failed'));
        };
        
        document.body.appendChild(script);
      });
    }

    // Load feedback data
    async function loadFeedback() {
      feedbackItems.innerHTML = `
        <div class="no-feedback">
          <p><i class="fas fa-spinner fa-spin"></i> Loading feedback...</p>
        </div>
      `;

      try {
        // Add cache-buster parameter
        const url = `${CONFIG.SCRIPT_URL}?t=${Date.now()}`;
        const response = await safeFetch(url);
        
        const data = await response.json();
        displayFeedback(data.data || data);
      } catch (error) {
        console.error("Failed to load feedback:", error);
        showNetworkError(error);
      }
    }

    function displayFeedback(feedbackData) {
      if (!feedbackData || feedbackData.length === 0) {
        feedbackItems.innerHTML = `
          <div class="no-feedback">
            <p>No feedback yet. Be the first to share!</p>
          </div>
        `;
        return;
      }

      // Sort by date (newest first)
      const sortedData = [...feedbackData].sort((a, b) => 
        new Date(b.Timestamp || 0) - new Date(a.Timestamp || 0)
      );

      feedbackItems.innerHTML = sortedData.map(item => `
        <div class="feedback-item">
          <div class="feedback-meta">
            <span class="feedback-author">${escapeHtml(item.Name || "Anonymous")}</span>
            <span class="feedback-date">${formatDate(item.Timestamp)}</span>
          </div>
          ${item.Rating ? `<div class="feedback-rating">${"★".repeat(item.Rating)}${"☆".repeat(5 - item.Rating)}</div>` : ''}
          <div class="feedback-content">
            <p>${escapeHtml(item.Feedback || "No message provided.")}</p>
          </div>
        </div>
      `).join('');
    }

    function showNetworkError(error) {
      feedbackItems.innerHTML = `
        <div class="no-feedback">
          <div class="network-error">
            <p><i class="fas fa-exclamation-triangle"></i> Connection Error</p>
            <p>${error.message}</p>
            <button onclick="loadFeedback()" class="retry-button">
              <i class="fas fa-sync-alt"></i> Try Again
            </button>
          </div>
        </div>
      `;
    }

    // Submit feedback
    feedbackForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      submitText.style.display = 'none';
      submitSpinner.style.display = 'inline';
      formError.style.display = 'none';

      try {
        const formData = new FormData(feedbackForm);
        const data = {
          Name: formData.get('name') || 'Anonymous',
          Rating: formData.get('rating') || 1,
          Feedback: formData.get('feedback'),
          Timestamp: new Date().toISOString()
        };

        // Validate feedback
        if (!data.Feedback || data.Feedback.trim() === '') {
          throw new Error('Please enter your feedback');
        }

        const response = await safeFetch(CONFIG.SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify(data),
          headers: { 
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.message || 'Submission failed');
        }

        feedbackForm.style.display = 'none';
        successMessage.style.display = 'block';
        
        setTimeout(() => {
          closeFeedbackModal();
          loadFeedback();
        }, 2000);
      } catch (error) {
        console.error('Submit error:', error);
        showFormError(error.message.includes('Failed to fetch') 
          ? 'Network error. Please check your connection.' 
          : error.message);
      } finally {
        submitText.style.display = 'inline';
        submitSpinner.style.display = 'none';
      }
    });

    function showFormError(message) {
      formError.textContent = message;
      formError.style.display = 'block';
      formError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Helper functions
    function formatDate(dateString) {
      if (!dateString) return "";
      const date = new Date(dateString);
      return isNaN(date.getTime()) ? "" : date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Initialize
    document.addEventListener("DOMContentLoaded", () => {
      loadFeedback();
    });

    // Make loadFeedback available globally for retry button
    window.loadFeedback = loadFeedback;
  </script>
</body>
</html>